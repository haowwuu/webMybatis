/*
 * File Name: IpPortUtil.java
 * Copyright: Copyright 2014-2014 CETC52 CETITI All Rights Reserved.
 * Description: 
 * Author: Wuwuhao
 * Create Date: 2016-8-31

 * Modifier: Wuwuhao
 * Modify Date: 2016-8-31
 * Bugzilla Id: 
 * Modify Content: 
 */
package com.cetiti.dsp.util;

import java.net.InetAddress;
import java.net.NetworkInterface;
import java.net.ServerSocket;
import java.net.SocketException;
import java.util.Enumeration;

import javax.jws.WebService;
import javax.xml.ws.Endpoint;



/**
 * 〈一句话功能简述〉
 * 
 * @author    Wuwuhao
 * @version   WSERP V1.0.0, 2016-8-31
 * @see       
 * @since     WSERP V1.0.0
 */

public class IpPortUtil {
	
	public static final String SERVER_IP = getIp();
			
	private static String getIp(){
		String localip = null;
		String netip = null;
		try {
			Enumeration<NetworkInterface> netInterfaces = NetworkInterface.getNetworkInterfaces();
			InetAddress ip = null;
			boolean finded = false;
			while (netInterfaces.hasMoreElements() && !finded) {
				NetworkInterface ni = netInterfaces.nextElement();
				Enumeration<InetAddress> address = ni.getInetAddresses();
				while (address.hasMoreElements()) {
					ip = address.nextElement();
					if (!ip.isSiteLocalAddress() && !ip.isLoopbackAddress()
							&& ip.getHostAddress().indexOf(":") == -1) {
						netip = ip.getHostAddress();
						finded = true;
						break;
					} else if (ip.isSiteLocalAddress()&& !ip.isLoopbackAddress()
							&& ip.getHostAddress().indexOf(":") == -1) {
						localip = ip.getHostAddress();
					}
				}
			}
		} catch (SocketException e) {
			throw new RuntimeException(e);
		}
		if (netip != null && !"".equals(netip)) {
			return netip;
		} else {
			return localip;
		}
	}
		
	public static Integer getAvailablePort(int port){
		ServerSocket socket = null;
		for(int i=0; i<2048; i++){
			try {
				socket = new ServerSocket(port+i);
			} catch (Exception e) { 
				
			} finally{
				if(null!=socket){
					try {
						socket.close();
						return port+i;
					} catch (Exception e2) {
						
					}
				}
			}
		}
		
		return null;
	}
	
	public static Integer getAvailableEndpointPort(int port){
		Endpoint endpoint = null;
		for(int i=0; i<2048; i++){
			try {
				endpoint = Endpoint.publish("http://"+SERVER_IP+":"+(port+i)+"/test", new Test());
			} catch (Exception e) { 
				
			} finally{
				if(null!=endpoint){
					endpoint.stop();
					return port+i;
				}
			}
		}
		
		return null;
	}
	
	@WebService
    static class Test{
		public void test(){
			
		}
	}
	
}
